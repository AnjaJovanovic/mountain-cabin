<div class="tourist-wrapper">
  <header class="tourist-header">
    <img src="uploads/logo.png" alt="Mountain Cabin Logo" class="logo">
  </header>

  @if (showDetail && selectedVikendica) {
    <h2 class="section-title">Detalji vikendice</h2>

    <div class="detail-card">
      <button routerLink="/touristVikendica" class="back-btn">← Nazad na listu</button>

      <h3 class="vikendica-name">{{ selectedVikendica.naziv }}</h3>
      <div class="vikendica-info">
        <p><strong>Mesto:</strong> {{ selectedVikendica.mesto }}</p>
        <p><strong>Telefon:</strong> {{ selectedVikendica.telefon }}</p>
        <p><strong>Cena noćenja (letnja):</strong> {{ selectedVikendica.cenaNocenjaLetnja }} €</p>
        <p><strong>Cena noćenja (zimska):</strong> {{ selectedVikendica.cenaNocenjaZimska }} €</p>

        <p>
          <strong>Prosečna ocena:</strong> {{ selectedVikendica.prosecnaOcena || 0 }}
          <span class="stars">
            <ng-container *ngFor="let s of getStars(selectedVikendica.prosecnaOcena)">
              <span [style.color]="s ? '#f5b301' : '#ccc'">★</span>
            </ng-container>
          </span>
        </p>

        <p><strong>Usluge:</strong> {{ selectedVikendica.usluge }}</p>

        @if (selectedVikendica.galerijaSlika && selectedVikendica.galerijaSlika.length > 0) {
          <div class="gallery">
            <strong>Galerija:</strong>
            <div class="gallery-images">
              @for (img of selectedVikendica.galerijaSlika; track $index) {
                <img [src]="'http://localhost:4000/' + img" alt="Slika" (click)="openImageModal(img)" class="gallery-thumbnail">
              }
            </div>
          </div>
        }

        @if (selectedVikendica.lat !== undefined && selectedVikendica.lng !== undefined) {
          <div class="map-section">
            <strong>Lokacija:</strong>
            <div id="vik-map"></div>
          </div>
        }

        <!-- Komentari i ocene -->
        <div class="reviews-section">
          <h3>Komentari i ocene gostiju</h3>
          @if (reviews.length === 0) {
            <p class="no-reviews">Još nema komentara i ocena za ovu vikendicu.</p>
          } @else {
            <div class="reviews-list">
              @for (review of reviews; track review.idRezervacije) {
                <div class="review-item">
                  <div class="review-header">
                    <span class="review-user">{{ review.usernameTuriste }}</span>
                    <span class="review-date">{{ formatDate(review.kraj) }}</span>
                  </div>
                  @if (review.touristRating) {
                    <div class="review-rating">
                      @for (star of getStars(review.touristRating); track $index) {
                        <span class="star" [class.filled]="star === 1" [class.half]="star === 0.5">★</span>
                      }
                      <span class="rating-value">({{ review.touristRating }})</span>
                    </div>
                  }
                  @if (review.touristComment) {
                    <div class="review-comment">{{ review.touristComment }}</div>
                  }
                </div>
              }
            </div>
          }
        </div>

        <div class="reservation-section">
          <h3>Rezervišite boravak</h3>

          @if (isVikendicaBlocked(selectedVikendica)) {
            <div class="blocked-message">
              <p class="blocked-text">Vikendica trenutno nije raspoloživa za izdavanje</p>
            </div>
          } @else {
            @if (step === 1) {
              <div class="reservation-form">
                <div class="form-field-group">
                  <label class="field-label">Početak rezervacije (od 14:00)</label>
                  <input type="datetime-local" [(ngModel)]="startISO" class="datetime-input">
                </div>

                <div class="form-field-group">
                  <label class="field-label">Kraj rezervacije (do 10:00)</label>
                  <input type="datetime-local" [(ngModel)]="endISO" class="datetime-input">
                </div>

                <div class="form-field-group">
                  <label class="field-label">Broj odraslih</label>
                  <input type="number" min="1" [(ngModel)]="adults" class="number-input">
                </div>

                <div class="form-field-group">
                  <label class="field-label">Broj dece</label>
                  <input type="number" min="0" [(ngModel)]="children" class="number-input">
                </div>
              </div>

              <div class="btn-row">
                <button (click)="proceedToPayment()">Nastavi</button>
                <span class="message">{{ reservationMessage }}</span>
              </div>
            } @else {
              <div class="payment-section">
                <p><strong>Vikendica:</strong> {{ selectedVikendica.naziv }}</p>
                <p><strong>Period:</strong> {{ formatDateTime(startISO) }} — {{ formatDateTime(endISO) }}</p>
                <p><strong>Gosti:</strong> Odraslih {{ adults }}, Dece {{ children }}</p>
                <p><strong>Cena:</strong> {{ formatEur(calculatedPrice) }}</p>

                <div>
                  <label>Napomena (opciono, do 500 karaktera)</label>
                  <textarea [(ngModel)]="note" rows="3" maxlength="500"></textarea>
                </div>

                <div>
                  <label>Kartica</label>
                  <input type="text" [(ngModel)]="cardNumber" placeholder="**** **** **** ****">
                </div>

                <div class="btn-row">
                  <button (click)="confirmReservation()">Potvrdi i plati</button>
                  <button type="button" (click)="backToStep1()" class="back-btn">Nazad</button>
                  <span class="message">{{ reservationMessage }}</span>
                </div>
              </div>
            }
          }
        </div>
      </div>
    </div>
  } @else {
    <h2 class="section-title">Dostupne vikendice</h2>

    <div class="filter-section">
      <div class="filter-item">
        <label>Naziv</label>
        <input type="text" [(ngModel)]="searchNaziv" (input)="applyFilter()" placeholder="Pretraga po nazivu">
      </div>
      <div class="filter-item">
        <label>Mesto</label>
        <input type="text" [(ngModel)]="searchMesto" (input)="applyFilter()" placeholder="Pretraga po mestu">
      </div>
      <div class="filter-actions">
        <button (click)="clearFilter()">Očisti</button>
      </div>
    </div>
    <div class="filter-count">
      <span class="count">Pronađeno: {{ filteredVikendice.length }}</span>
    </div>

    <table class="vikendice-table">
      <thead>
        <tr>
          <th (click)="sort('naziv')" class="sortable-header">
            Naziv
            @if (sortColumn === 'naziv') {
              <span class="sort-indicator">{{ sortDirection === 'asc' ? '↑' : '↓' }}</span>
            }
          </th>
          <th (click)="sort('mesto')" class="sortable-header">
            Mesto
            @if (sortColumn === 'mesto') {
              <span class="sort-indicator">{{ sortDirection === 'asc' ? '↑' : '↓' }}</span>
            }
          </th>
          <th>Prosečna ocena</th>
        </tr>
      </thead>
      <tbody>
        @for (v of filteredVikendice; track v.idVikendice) {
          <tr>
            <td><a [routerLink]="['/touristVikendica', v.idVikendice]">{{ v.naziv }}</a></td>
            <td>{{ v.mesto }}</td>
            <td>
              <div class="rating-cell">
                @if (v.prosecnaOcena && v.prosecnaOcena > 0) {
                  <span class="rating-value">{{ formatRating(v.prosecnaOcena) }}</span>
                  <div class="stars">
                    @for (star of getStars(v.prosecnaOcena); track $index) {
                      <span class="star" [class.filled]="star === 1" [class.half]="star === 0.5">★</span>
                    }
                  </div>
                } @else {
                  <span class="no-rating">Nema ocene</span>
                }
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }

  <!-- Image Modal -->
  @if (showImageModal && selectedImage) {
    <div class="image-modal-overlay" (click)="closeImageModal()">
      <div class="image-modal-content" (click)="$event.stopPropagation()">
        <button class="image-modal-close" (click)="closeImageModal()">×</button>
        <img [src]="selectedImage" alt="Velika slika" class="image-modal-image">
      </div>
    </div>
  }

  <!-- Reservation Confirmation Modal -->
  @if (showReservationConfirmation && reservationDetails) {
    <div class="reservation-confirmation-overlay" (click)="closeReservationConfirmation()">
      <div class="reservation-confirmation-content" (click)="$event.stopPropagation()">
        <div class="confirmation-header">
          <h2>✓ Rezervacija uspešno kreirana</h2>
          <button class="confirmation-close" (click)="closeReservationConfirmation()">×</button>
        </div>
        <div class="confirmation-body">
          <div class="confirmation-details">
            <div class="detail-row">
              <strong>Broj rezervacije:</strong>
              <span>#{{ reservationDetails.idRezervacije }}</span>
            </div>
            <div class="detail-row">
              <strong>Vikendica:</strong>
              <span>{{ reservationDetails.naziv }}</span>
            </div>
            <div class="detail-row">
              <strong>Mesto:</strong>
              <span>{{ reservationDetails.mesto }}</span>
            </div>
            <div class="detail-row">
              <strong>Početak:</strong>
              <span>{{ reservationDetails.pocetak }}</span>
            </div>
            <div class="detail-row">
              <strong>Kraj:</strong>
              <span>{{ reservationDetails.kraj }}</span>
            </div>
            <div class="detail-row">
              <strong>Gosti:</strong>
              <span>Odraslih: {{ reservationDetails.brojOdraslih }}, Dece: {{ reservationDetails.brojDece }}</span>
            </div>
            <div class="detail-row">
              <strong>Cena:</strong>
              <span>{{ formatEur(reservationDetails.cena) }}</span>
            </div>
            @if (reservationDetails.napomena) {
              <div class="detail-row">
                <strong>Napomena:</strong>
                <span>{{ reservationDetails.napomena }}</span>
              </div>
            }
          </div>
          <div class="confirmation-footer">
            <p class="confirmation-note">Rezervacija je poslata vlasniku na odobrenje. Bićete obavešteni kada vlasnik potvrdi ili odbije rezervaciju.</p>
            <button class="confirmation-btn" (click)="closeReservationConfirmation()">U redu</button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
