<div class="tourist-wrapper">
  <header class="tourist-header">
    <img src="uploads/logo.png" alt="Mountain Cabin Logo" class="logo">
  </header>

  @if (showDetail && selectedVikendica) {
    <h2 class="section-title">Detalji vikendice</h2>

    <div class="detail-card">
      <button routerLink="/touristVikendica" class="back-btn">← Nazad na listu</button>

      <h3 class="vikendica-name">{{ selectedVikendica.naziv }}</h3>
      <div class="vikendica-info">
        <p><strong>Mesto:</strong> {{ selectedVikendica.mesto }}</p>
        <p><strong>Telefon:</strong> {{ selectedVikendica.telefon }}</p>
        <p><strong>Cena noćenja (letnja):</strong> {{ selectedVikendica.cenaNocenjaLetnja }} €</p>
        <p><strong>Cena noćenja (zimska):</strong> {{ selectedVikendica.cenaNocenjaZimska }} €</p>
        <p><strong>Zauzeta:</strong> {{ selectedVikendica.zauzeta ? 'Da' : 'Ne' }}</p>

        <p>
          <strong>Prosečna ocena:</strong> {{ selectedVikendica.prosecnaOcena || 0 }}
          <span class="stars">
            <ng-container *ngFor="let s of getStars(selectedVikendica.prosecnaOcena)">
              <span [style.color]="s ? '#f5b301' : '#ccc'">★</span>
            </ng-container>
          </span>
        </p>

        <p><strong>Usluge:</strong> {{ selectedVikendica.usluge }}</p>

        @if (selectedVikendica.galerijaSlika && selectedVikendica.galerijaSlika.length > 0) {
          <div class="gallery">
            <strong>Galerija:</strong>
            <div class="gallery-images">
              @for (img of selectedVikendica.galerijaSlika; track $index) {
                <img [src]="'http://localhost:4000/' + img" alt="Slika">
              }
            </div>
          </div>
        }

        @if (selectedVikendica.lat !== undefined && selectedVikendica.lng !== undefined) {
          <div class="map-section">
            <strong>Lokacija:</strong>
            <div id="vik-map"></div>
          </div>
        }

        <div class="reservation-section">
          <h3>Rezervišite boravak</h3>

          @if (step === 1) {
            <div class="reservation-form">
              <div class="form-field-group">
                <label class="field-label">Početak rezervacije (od 14:00)</label>
                <input type="datetime-local" [(ngModel)]="startISO" class="datetime-input">
              </div>

              <div class="form-field-group">
                <label class="field-label">Kraj rezervacije (do 10:00)</label>
                <input type="datetime-local" [(ngModel)]="endISO" class="datetime-input">
              </div>

              <div class="form-field-group">
                <label class="field-label">Broj odraslih</label>
                <input type="number" min="1" [(ngModel)]="adults" class="number-input">
              </div>

              <div class="form-field-group">
                <label class="field-label">Broj dece</label>
                <input type="number" min="0" [(ngModel)]="children" class="number-input">
              </div>
            </div>

            <div class="btn-row">
              <button (click)="proceedToPayment()">Nastavi</button>
              <span class="message">{{ reservationMessage }}</span>
            </div>
          } @else {
            <div class="payment-section">
              <p><strong>Vikendica:</strong> {{ selectedVikendica.naziv }}</p>
              <p><strong>Period:</strong> {{ formatDateTime(startISO) }} — {{ formatDateTime(endISO) }}</p>
              <p><strong>Gosti:</strong> Odraslih {{ adults }}, Dece {{ children }}</p>
              <p><strong>Cena:</strong> {{ formatEur(calculatedPrice) }}</p>

              <div>
                <label>Napomena (opciono, do 500 karaktera)</label>
                <textarea [(ngModel)]="note" rows="3" maxlength="500"></textarea>
              </div>

              <div>
                <label>Kartica</label>
                <input type="text" [(ngModel)]="cardNumber" placeholder="**** **** **** ****">
              </div>

              <div class="btn-row">
                <button (click)="confirmReservation()">Potvrdi i plati</button>
                <button type="button" (click)="backToStep1()" class="back-btn">Nazad</button>
                <span class="message">{{ reservationMessage }}</span>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  } @else {
    <h2 class="section-title">Dostupne vikendice</h2>

    <div class="filter-section">
      <div class="filter-item">
        <label>Naziv</label>
        <input type="text" [(ngModel)]="searchNaziv" (input)="applyFilter()" placeholder="Pretraga po nazivu">
      </div>
      <div class="filter-item">
        <label>Mesto</label>
        <input type="text" [(ngModel)]="searchMesto" (input)="applyFilter()" placeholder="Pretraga po mestu">
      </div>
      <div class="filter-actions">
        <button (click)="clearFilter()">Očisti</button>
        <span class="count">Pronađeno: {{ filteredVikendice.length }}</span>
      </div>
    </div>

    <table class="vikendice-table">
      <thead>
        <tr>
          <th>Naziv</th>
          <th>Mesto</th>
          <th>Prosečna ocena</th>
        </tr>
      </thead>
      <tbody>
        @for (v of filteredVikendice; track v.idVikendice) {
          <tr>
            <td><a [routerLink]="['/touristVikendica', v.idVikendice]">{{ v.naziv }}</a></td>
            <td>{{ v.mesto }}</td>
            <td>
              <div class="rating-cell">
                @if (v.prosecnaOcena && v.prosecnaOcena > 0) {
                  <span class="rating-value">{{ formatRating(v.prosecnaOcena) }}</span>
                  <div class="stars">
                    @for (star of getStars(v.prosecnaOcena); track $index) {
                      <span class="star" [class.filled]="star === 1" [class.half]="star === 0.5">★</span>
                    }
                  </div>
                } @else {
                  <span class="no-rating">Nema ocene</span>
                }
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }
</div>
